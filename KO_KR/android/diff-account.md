MSDK Different Account 
=======

Diff계정이란?
---

Diff계정은 현재 게임에 로그인한 계정과 플랫폼에 로그인한 계정이 일치하지 않는 경우를 말합니다. 아래와 같은 2가지 경우가 있습니다.

1. 플랫폼은 같지만 계정이 다름(예를 들면 게임과 모바일QQ가 다른 QQ계정으로 로그인)
2. 플랫폼이 다름(예를 들면 게임은 위챗으로 로그인하고 게임 관련 조작은 모바일QQ에서 진행)

Diff계정 시나리오
---

 1. 게임에서 메시지를 공유할 시 플랫폼을 실행할 경우 계정이 일치하지 않으면 플랫폼에서 팝업창으로 Diff계정으로 로그인하였음을 안내합니다. 현재 플랫폼에서 모두 해당 기능을 지원할 수 있습니다.

	![game2qq](./diff-account-game2qq.png) 
    ![game2wechat](./diff-account-game2wechat.png)

 2. 유저가 플랫폼을 통하여 게임을 실행할 경우 계정이 일치하지 않으면 게임에서 팝업창으로 Diff계정으로 로그인하였음을 안내하여야 합니다.

	![plat2wechat](./diff-account-plat2wechat.png) 

`현재 게임 런칭 시 플랫폼에서 권장하는 것은 두번째 방안,즉 게임에서 처리하는 Diff계정과 MSDK에서 구현한 Diff계정은 모두 두번째 방안을 권장드립니다.`

Diff계정 처리 로직
---
MSDK의 Diff계정 처리 로직은 Diff계정 판단,유저 계정 선택,Diff계정 로그인 3개 절차가 포함됩니다.(자세한 내용은 MSDK연동 문서 참조).

####1. Diff계정 판단:

외부 플랫폼에서 게임 실행시 MSDK는 handCallback에서 실행 플랫폼과 게임 로컬 계정에 Diff계정 존재 여부를 판단하고 Diff계정 판단 결과를 OnWakeupNotify(WakeupRet ret) 방법의 ret.flag를 통하여 게임에 콜백합니다. 게임은 콜백 결과에 따라 해당한 로그인 처리를 진행할 수 있습니다. 자세한 ret.flag 및 해당 처리는 아래와 같습니다.

	eFlag_Succ: Diff계정이 없으며 로컬 계정으로 로그인 성공. 게임은 이 flag를 받은 후 바로 LoginRet 구조체의 토큰을 획득하여 게임 인증 절차를 진행합니다.

	eFlag_AccountRefresh: Diff계정이 없으며 MSDK에서 이미 인터페이스 리셋을 통하여 로컬 계정 토큰을 리셋. 이 flag를 받은 후 바로 LoginRet 구조체의 토큰을 획득하여 게임 인증 절차를 진행합니다.

	eFlag_UrlLogin：Diff계정이 없으며 게임은 계정을 호출하여 빠른 로그인.게임은 이 flag 받은 후 onLoginNotify의 콜백을 받아야만 처리할 수 있습니다.

	eFlag_NeedLogin：게임 로컬 계정과 실행 계정이 모두 로그인 실패. 게임이 이 flag를 수신하면 로그인창을 팝업하여 유저를 로그인하게 해야 한다.

	eFlag_NeedSelectAccount：게임 로컬 계정과 실행 계정에 Diff계정이 존재. 게임이 이 flag를 받은 후 대화창을 팝업하여 유저들이 로그인 계정을 선택하도록 합니다.

####2. 유저 선택:

Diff계정이 판단한 ret.flag가 eFlag_NeedSelectAccount일 경우, 게임은 대화창을 팝업하여 로컬 계정 혹은 Diff계정으로 로그인할 지 선택하도록 합니다. 게임은 유저가 선택한 결과에 따라 인터페이스 WGSwitchUser를 호출하여 로그인을 완료합니다.

		/**
		 *  외부에서 실행한 URL을 통하여 로그인. 이 인터페이스는 Diff계정 발생시 유저가 외부에서 계정 실행시 호출합니다.
	 	*  로그인 성공 후 onLoginNotify를 통하여 콜백
	 	*
	 	*  @param flag 가 YES일 경우, 유저가 실행 계정으로 변경. 이럴 경우 이 인터페이스는 전에 저장한 실행 계정으로 로그인.로그인에 성공하면 onLoginNotify를 통하여 콜백. 토큰이 없거나 토큰이 무효함수이면 NO를 리턴하고 onLoginNotify 콜백이 발생하지 않습니다.
	 	*              NO이면, 유저가 원래 로컬계정을 계속 사용한다는 것을 표시한다. 이때 저장된 실행 계정 데이터를 삭제하여 혼동을 방지한다.
	 	*
	 	*  @return 토큰이 없거나 무효하면 NO 리턴; 다른 경우는 YES 리턴
		 */
		bool WGSwitchUser(bool flag);

####3. 로그인 콜백 리턴:

WGSwitchUser의 파라미터가 true일 경우，MSDK는 게임 호출 시의 상태에 따라 로그인을 시도하고 onLoginNotify를 통하여 로그인 결과를 게임에 콜백합니다. 게임은 콜백 결과에 따라 로그인 결과를 처리합니다.

플랫폼에서 게임까지의 Diff계정 9가지 경우
----

**개발자는 MSDK에서 게임에 콜백한 flag만 주목하면 됩니다.**：

|           |완전한 토큰을 갖고 실행|완전한 토큰이 없이 실행|토큰이 없이 실행|
|: ------------- :|: ------------- :|: ------------- :|: ------------- :|
|로컬 토큰 유효|유저에게 Diff계정 안내|유저에게 Diff계정 안내|로컬 계정으로 로그인|
|로컬 토큰 무효|유저에게 Diff계정 안내|유저에게 Diff계정 안내|게임은 로그인 페이지로 이동|
|로컬에 무토큰|계정을 통해 로그인|게임은 로그인 페이지로 이동|게임은 로그인 페이지로 이동|


Diff계정 버전 지원
-----
####게임에서 플랫폼까지의 Diff계정:

1. 1.3.0.11 이하 버전,게임에서 위챗까지의 Diff계정은 MSDK에서 BUG를 감지할 수 있어 자동 로그인 시 안내가 없는 문제가 발생합니다. MSDK 버전을 1.3.0.11 이상으로 업데이트후 해당 문제를 해결할 것을 권장드립니다.
2. 게임에서 위챗으로 Diff계정은 위챗 5.0 및 이상 버전에서만 지원한다.

####플랫폼에서 게임까지의 Diff계정:
1. MSDK는 1.8.0부터 Diff계정을 지원하므로 현재 모바일QQ만 토큰을 갖고 실행할 수 있습니다.
2. 모바일QQ 4.6 이하 버전,모바일QQ에서 게임까지의 Diff계정은 이미 게임을 실행한 상황에서는 존재하지 않습니다.


##FAQ

1. 공유한 메시지를 클릭하여 Diff계정이 없다：메시지 보기를 클릭[공유 메시지 클릭 효과](share.md#공유 메시지 클릭 효과)현재 조작이 Diff계정을 유발 여부를 확인.
2. 모바일 QQ 게임 호출하여 로그인 불가：[클릭하여 QQ지원하는 퀵 로그인 조건을 알아보기](qq.md#퀵 로그인)，네용에 의하여 현 게임 QQ 퀵 로그인 지원 여부를 확인.